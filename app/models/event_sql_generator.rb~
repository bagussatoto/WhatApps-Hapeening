require 'nokogiri'
require 'open-uri'

# test.html is from http://www.experiencecolumbus.com/event-search?keyword=&sdate=04%2F17%2F15&edate=04%2F19%2F15&free=&cat=9&start=1
# all the events are generated by javascript so it doesn't do us any good to grab it form the URL since nokogiri doesn't run the js

# INSERT INTO EVENT VALUES(START_DATE, END_DATe, LOCATION, NAME, PRICE, DESCRIPTION, LINK)

# TODO: fix the js problem
@doc = Nokogiri::HTML(open('./test.html'))
scrapedInfo = Array.new

title = @doc.css(".results").css("li").each do |node|
	scrapedInfo.push(node)
end
filename = 'event_insert.sql'
target = open(filename, 'w')
nullstr = 'NULL'
scrapedInfo.each do |node|
	if !node.css('h3').text.empty? then
		name = node.css('h3').text # Gets Name
		venue = node.css('h4').text # Gets Venue
		start_date = node.css('.dtstart').text # Gets Start Time
		if node.css('.dtend').text.empty? then
			end_date = node.css('.dtstart').text # Gets Start Time
		else
			end_date = node.css('.dtend').text # Gets Start Time
		end
		location = node.css('ul > li > a').text # Gets Location
		page = node.css('h3 > a')
		url = page[0]['href']

		sqlinsert = 'INSERT INTO EVENT VALUES(\'' + start_date + '\',\'' + end_date + '\',\'' + venue + ' @ ' + location + '\',\'' + name + '\',' + nullstr + ',' + nullstr + ',\'' + url +'\')'
		target.puts sqlinsert
	end
end
